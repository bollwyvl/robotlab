parameters:
  products:
    - MiniRobot
  platforms:
    - name: Linux
      vmImage: ubuntu-16.04
      activate: ""
    - name: MacOSX
      vmImage: macos-10.13
      activate: ""
    - name: Windows
      vmImage: vs2017-win2016
      activate: call activate &&

jobs:
  - ${{ each product in parameters.products }}:
    - ${{ each platform in parameters.platforms }}:
      - job: ${{ product }}${{ platform.name }}Build
        condition: succeeded()
        pool:
          vmImage: ${{ platform.vmImage }}

        steps:
          - template: steps.conda.yml
            parameters:
              name: ${{ platform.name }}
              envPath: ci/env-main.yml

          - script: ${{ platform.activate }} python -m scripts.build constructor ${{ product }}
            displayName: build installer

          - ${{ if eq(parameters.name, 'MacOSX') }}:
            - script: chmod -R 777 _artifacts
              displayName: fix artifact permissions

          - task: PublishPipelineArtifact@1
            displayName: publish installer
            inputs:
              targetPath: _artifacts/constructor
              artifactName: ${{ product }} for ${{ platform.name }} $(Build.BuildId)
            condition: succeeded()
